*<<C语言程序设计现代方法>>*  
*Date: 2019.07.12*

+++

# 第15章 编写大规模程序

## 源文件 

## 头文件(或包含文件)

> c标准使用术语"源文件"指示程序员编写的全部文件, 这里"源文件"只是指.c文件.

### \#include指令

|    `#include<文件名>`    |        `include<"文件名">`        |
| :----------------------: | :-------------------------------: |
| 搜索系统头文件所在的目录 | 搜索当前目录,再搜索头文件所在目录 |

### 共享宏定义和类型定义[^1]

> 将宏定义或类型定义放置于一个头文件`xxx.h`中再在需要的源文件中`include`即可.

### 共享函数原型

> 需建立**项目**使得多个源文件同时编译, 在头文件中建立函数申明,定义函数的源文件和调用函数的源文件都需要`include`源文件. 

### 共享变量声明[^2]

> - 声明没有定义的变量用`extern`, 例如`extern int i;`(由于关键字extern, 使得编译器不会在每次编译某个源文件时为变量分配额外的内存空间).
> -  `extern int a[];` : 可忽略数组的长度.

> 1. 在其他文件通过声明变量, 可以访问/修改变量.
> 2. 为确保**变量的所有声明和变量的定义一致**, 仿照共享函数的做法, 将共享函数的变量放置在头文件再`include`.

### 嵌套包含[^3]

> 在一个头文件中包含另一个头文件.

### 保护头文件

​	___缘由: 如果一个源文件包含同一个头文件两次, 那么可能会产生编译错误的结果, 尤其是包含类型定义时.___  
​	***结果: 可避免相同头文件的重复编译以节省时间.***  
​	___解决方法:___  

> 采用宏指令把文件内容**闭合**起来:  
>
> ```c
> #ifdef BOOLEAN_H
> #define BOOLEAN_H
> 
> define TURE 1
> define FALSE 0
> typedef int Bool
> 
> #endif
> ```

### 头文件中的\#error指令

> 将**\#error**指令放置在头文件中可用来检查不应该包含此头文件的一些条件:
>
> ```c
> #ifndef DOS //只允许DOS程序包含此头文件
> #error Graphics supported only under DOS
> #endif
> ```

## 把程序划分为多个文件

> 书中构建了一个文本格式化的小程序[^4].

## 构建多文件程序

> - **编译**: 包含头文件的源文件编译时会自动编译头文件. 编译时会产生目标文件(objective file), 即`.o`文件. 此文件包含来自每个源文件的目标代码.
> - __链接__: 链接把目标代码和库函数结合在一起生成可执行程序; 以及解决编译器遗留的**外部参考问题**(外部参考发生在一个文件的函数调用另一个文件定义的函数或是访问另一个文件定义的变量时).

### makefile(基于UNIX)

> 这个文件包含构建程序的必要信息, __makefile__不仅列出了作为程序部分的文件, 还描述了文件之间的依赖性.

### 链接期间的错误

> - **拼写错误.**
> - __丢失文件.__
> - **丢失库.**

### 重新构建程序

> - 源文件修改: 只需此文件重编译再链接.
> - 头文件修改: 虚重新编译包含此头文件的所有文件.

<u>**注: 使用makefile可通过检查文件日期自动进行重新构建**</u>

### 在程序外定义宏

>```
>% cc -DDEBUG=1 xxx.c	//选项-D定义宏DEBUG在程序xxx.c中值为1, 若不指定即为1
>% cc -UDEBUG xxx.c	//选项-U类似于#undef, 即未定义宏
>```

## 一些问题

1. 可以用**\#include**包含源文件, 但最好不要这样做.
2. 通过整合每个源文件的头文件所构成的大的头文件其造成的坏处远大于好处.
3. `extern int a[]`不可用`extern int *a`代替, **在变量声明中, 数组和指针已是截然不同的两种类型**.
4. 大多数链接器只会链接程序实际需要的函数.

+++

[^1]: typedef
[^2]: 在文件中共享变量是C语言的长期惯例, 但它有重大的缺点, 19章将会学习设计不需要共享变量的程序
[^3]:早期虽不允许嵌套包含, 但这种偏见正在减弱(在C++中已普遍应用)
[^4]:在此不深究, 只涉及思想, 不考虑实践